---
title: "Pipelining HIV+ Country-wide Meta-analysis of Sub-Saharan Africa"
output:
  html_document:
    df_print: paged
---

### Source file:
* s3://dhs-hivdata/univariateResults.0923.tgz

### No output files found for:
./data/univariateresults//Benin/Standard_DHS_1996/Uni/m: no files found
./data/univariateresults//Benin/Standard_DHS_1996/Uni/f: no files found
./data/univariateresults//Benin/Standard_DHS_2001/Uni/m: no files found
./data/univariateresults//Benin/Standard_DHS_2001/Uni/f: no files found
./data/univariateresults//Benin/Standard_DHS_2006/Uni/m: no files found
./data/univariateresults//Benin/Standard_DHS_2006/Uni/f: no files found
./data/univariateresults//Benin/Standard_DHS_2011-12/Uni/m: no files found
./data/univariateresults//Benin/Standard_DHS_2011-12/Uni/f: no files found
./data/univariateresults//Burkina_Faso/Standard_DHS_1993/Uni/m: no files found
./data/univariateresults//Burkina_Faso/Standard_DHS_1993/Uni/f: no files found
./data/univariateresults//Burkina_Faso/Standard_DHS_1998-99/Uni/m: no files found
./data/univariateresults//Burkina_Faso/Standard_DHS_1998-99/Uni/f: no files found
./data/univariateresults//Burundi/Standard_DHS_1987/Uni/m: no files found
./data/univariateresults//Burundi/Standard_DHS_1987/Uni/f: no files found
./data/univariateresults//Cameroon/Standard_DHS_1991/Uni/m: no files found
./data/univariateresults//Cameroon/Standard_DHS_1991/Uni/f: no files found
./data/univariateresults//Cameroon/Standard_DHS_1998/Uni/m: no files found
./data/univariateresults//Cameroon/Standard_DHS_1998/Uni/f: no files found
./data/univariateresults//Cameroon/Standard_DHS_2011/Uni/m: no files found
./data/univariateresults//Cameroon/Standard_DHS_2011/Uni/f: no files found
./data/univariateresults//Central_African_Republic/Standard_DHS_1994-95/Uni/m: no files found
./data/univariateresults//Central_African_Republic/Standard_DHS_1994-95/Uni/f: no files found
./data/univariateresults//Chad/Standard_DHS_1996-97/Uni/m: no files found
./data/univariateresults//Chad/Standard_DHS_1996-97/Uni/f: no files found
./data/univariateresults//Chad/Standard_DHS_2004/Uni/m: no files found
./data/univariateresults//Chad/Standard_DHS_2004/Uni/f: no files found
./data/univariateresults//Comoros/Standard_DHS_1996/Uni/m: no files found
./data/univariateresults//Comoros/Standard_DHS_1996/Uni/f: no files found
./data/univariateresults//Comoros/Standard_DHS_2012/Uni/m: no files found
./data/univariateresults//Comoros/Standard_DHS_2012/Uni/f: no files found
./data/univariateresults//Congo/Standard_DHS_2005/Uni/m: no files found
./data/univariateresults//Congo/Standard_DHS_2005/Uni/f: no files found
./data/univariateresults//Congo/Standard_DHS_2011-12/Uni/m: no files found
./data/univariateresults//Congo/Standard_DHS_2011-12/Uni/f: no files found
./data/univariateresults//Cote_d'Ivoire/Standard_DHS_1994/Uni/m: no files found
./data/univariateresults//Cote_d'Ivoire/Standard_DHS_1994/Uni/f: no files found
./data/univariateresults//Cote_d'Ivoire/Standard_DHS_1998-99/Uni/m: no files found
./data/univariateresults//Cote_d'Ivoire/Standard_DHS_1998-99/Uni/f: no files found
./data/univariateresults//Ethiopia/Standard_DHS_2000/Uni/m: no files found
./data/univariateresults//Ethiopia/Standard_DHS_2000/Uni/f: no files found
./data/univariateresults//Gabon/Standard_DHS_2000/Uni/m: no files found
./data/univariateresults//Gabon/Standard_DHS_2000/Uni/f: no files found
./data/univariateresults//Gambia/Standard_DHS_2013/Uni/m: no files found
./data/univariateresults//Gambia/Standard_DHS_2013/Uni/f: no files found
./data/univariateresults//Ghana/Standard_DHS_1988/Uni/m: no files found
./data/univariateresults//Ghana/Standard_DHS_1988/Uni/f: no files found
./data/univariateresults//Ghana/Standard_DHS_1993/Uni/m: no files found

### Notes from meeting, 10/30
- latent variable analysis - farmworker or fisherman, asked about it different ways; look at the varlabel string

```{r echo=FALSE}
library('tidyverse')
library('metafor')
library('DT')
load('./meta_data/hiv_summary_stats.Rdata') ## see traverse_directory.R
summary_statistics <- hiv_replicated
```

```{r}
## meta-analysis code
meta_for_one <- function(estimates, ses, ...) {
  ## Dersimonian-Laird RF
  mod <- rma.uni(yi=estimates, sei=ses, method = 'DL', ...)
  return(mod)
}
```

## Raw Number of Replicated Associations
* replicated in 2 independent datasets (FDR < 0.05 and p < 0.05)

```{r}
nrow(summary_statistics)
```

```{r}
hiv_train$data_type <- 'train'
hiv_test$data_type <- 'test'
trainTest <- rbind(unique(hiv_train), unique(hiv_test))

numInBothTrainAndTest <- trainTest %>% group_by(country, survey, gender, var) %>% summarize(n=n()) %>% filter(n == 2) %>% ungroup() %>% select(-n) %>% group_by(country, survey, gender) %>% summarize(total=n())

numReplicated <- summary_statistics %>% group_by(country, survey, gender) %>% summarize(n=n())

yield <- left_join(numInBothTrainAndTest, numReplicated) %>% mutate(pct = n/total)
DT::datatable(yield)
```

```{r}
p <- ggplot(yield, aes(pct*100, color=gender))
p <- p + stat_ecdf() 
p <- p + xlab('Percent Variables Replicated') + ylab('Quantile')
p
```

## How many times each variable was found
```{r}
varDesc <- unique(summary_statistics[, c('var', 'varlabel')]) %>% group_by(var) %>% filter(row_number() == 1)
metaCharacteristics <- summary_statistics %>% group_by(gender, var) %>% summarise(n_surveys=n(), n_countries=length(unique(country))) %>% merge(., varDesc)
DT::datatable(metaCharacteristics[order(metaCharacteristics$n_surveys, decreasing=T),], rownames = F)
```


- within a country
- entire var
- region of africa
- by year, pooled effects prior to 2010 and after

### within country
```{r}
surveyChars <- strsplit(summary_statistics$survey, "\\_")
summary_statistics$year <- unlist(lapply(surveyChars, function(x) { x[3] }))

## within a country, count how many surveys for a variable
numVariablesPerCountry <- summary_statistics %>% group_by(country, var, gender) %>% summarize(num_surveys=n())
meta_analysis_country <- summary_statistics %>% group_by(country, var, gender) %>% do(meta=meta_for_one(.$Estimate, .$SE, slab=sprintf('%s-%s-%s', .$country, .$year, .$gender)))
meta_analysis_country <- left_join(numVariablesPerCountry, meta_analysis_country)

```

### within entire var
```{r}
numVariablesPerContinent <- summary_statistics %>% group_by(var, gender) %>% summarize(num_surveys=n())
meta_analysis_continent <- summary_statistics %>% group_by(var, gender) %>% do(meta=meta_for_one(.$Estimate, .$SE, slab=sprintf('%s-%s-%s', .$country, .$year, .$gender)))
meta_analysis_continent <- left_join(meta_analysis_continent, numVariablesPerContinent)
```

## save the work
```{r}
save(yield, meta_analysis_country, meta_analysis_continent, summary_statistics, varDesc, metaCharacteristics, file='meta_hiv_110518.Rdata')
```

